<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Set Pro Training</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div id="app-container" class="app-container">
    <div class="resizer resizer-l" id="resizer-l"></div>
    <div class="resizer resizer-r" id="resizer-r"></div>

    <svg style="position: absolute; width: 0; height: 0;">
        <defs id="svg-defs"></defs>
    </svg>

    <div id="swipe-zone"></div>

    <div class="hud-layer">
        <div class="hud-left">
            <div id="possible-area" class="flex flex-col gap-1">
                <div id="possible-label" class="text-lg font-bold">Possible: <span id="possible-count" class="text-pink-400">0</span></div>
                <div id="detailed-possible" class="flex gap-1 transition-opacity duration-300">
                    <div class="det-panel"><span class="det-val" id="det-4">0</span><span class="det-label">Diff</span></div>
                    <div class="det-panel"><span class="det-val" id="det-3">0</span><span class="det-label">1 Sm</span></div>
                    <div class="det-panel"><span class="det-val" id="det-2">0</span><span class="det-label">2 Sm</span></div>
                    <div class="det-panel"><span class="det-val" id="det-1">0</span><span class="det-label">3 Sm</span></div>
                </div>
            </div>
        </div>
        <div class="hud-right">
            <div class="flex flex-col items-end">
                <div class="flex items-center gap-2">
                    <div id="live-spm" class="font-mono text-lg font-black" style="display:none; text-shadow: 0 0 10px currentColor;">0.0</div>
                    <div id="timer" class="font-mono bg-black/20 px-3 py-1 rounded text-lg font-bold">00:00</div>
                </div>
                <div id="seed-label" class="seed-indicator" style="display:none">Synchronized Seed ON</div>
            </div>
        </div>
    </div>

    <div id="debug-edge-container" class="debug-edge-container" style="display:none">
        <div class="text-gray-400 text-xs">MS: <span id="debug-delay" class="font-mono">—</span></div>
        <div class="text-gray-400 text-xs">TPS: <span id="debug-tps-iters" class="font-mono">disabled</span></div>
    </div>

    <div class="settings-edge-container">
        <div class="settings-btn" onpointerdown="toggleSettingsModal(true)" data-svg-icon="SETTINGS"></div>
        <div class="text-gray-300 text-sm font-medium">Sets: <span id="current-score" class="text-pink-400 font-bold">0</span></div>
        <div class="text-gray-400 text-xs">Cards: <span id="deck-count">0</span></div>
    </div>

    <div class="fixed-core">
        <div class="h-[15px] flex-shrink-0"></div> <div id="board">
            <div class="card-slot"></div><div class="card-slot"></div><div class="card-slot"></div><div class="card-slot"></div>
            <div class="card-slot"></div><div class="card-slot"></div><div class="card-slot"></div><div class="card-slot"></div>
            <div class="card-slot"></div><div class="card-slot"></div><div class="card-slot"></div><div class="card-slot"></div>
        </div>

        <div class="bottom-actions">
            <button onpointerdown="handleGameFinish()" class="btn-action">Finish</button>
            <button id="shuffle-btn" onpointerdown="handleShuffleClick()" class="btn-action">Shuffle</button>
        </div>
    </div>

    <div id="settings-modal" class="overlay">
        <h2 class="text-2xl font-black mb-6 text-pink-400 uppercase tracking-widest">Settings</h2>
        <div class="w-full flex flex-col items-center">
          <div class="settings-row">
              <span class="text-sm font-bold uppercase">Appearance</span>
              <button onpointerdown="openBoardAppearanceModal()" class="btn-action !w-32 !py-1 !text-[15px] !shadow-none !rounded-lg">Edit Board</button>
          </div>
          <div class="settings-row">
              <span class="text-sm font-bold uppercase">Show Possible</span>
              <div id="toggle-possible" class="toggle-switch" onpointerdown="toggleOption('showPossible')"></div>
          </div>
          <div class="settings-row">
              <span class="text-sm font-bold uppercase text-[12px]">Show Sets Per Minute</span>
              <div id="toggle-spm" class="toggle-switch" onpointerdown="toggleOption('showSPM')"></div>
          </div>
          <div class="settings-row">
              <span class="text-sm font-bold uppercase">Show Timer</span>
              <div id="toggle-timer" class="toggle-switch" onpointerdown="toggleOption('showTimer')"></div>
          </div>
          <div class="settings-row desktop-only mt-4">
              <span class="text-sm font-bold uppercase">Controls</span>
              <button onpointerdown="openKeybindsModal()" class="btn-action !w-32 !py-1 !text-[15px] !shadow-none !rounded-lg">Edit Keybinds</button>
          </div>

          <div class="settings-row">
              <span class="text-sm font-bold uppercase">Online</span>
              <button onpointerdown="openOnlineSettingsModal()" class="btn-action !w-32 !py-1 !text-[15px] !shadow-none !rounded-lg">Settings</button>
          </div>

          <div class="settings-row">
              <span class="text-sm font-bold uppercase">Extra</span>
              <button onpointerdown="openAdvancedModal()" class="btn-action !w-32 !py-1 !text-[15px] !shadow-none !rounded-lg">Advanced</button>
          </div>
      </div>
      <button onpointerdown="toggleSettingsModal(false)" class="btn-action !w-64 text-xl py-4 uppercase mt-8">Close</button>
    </div>

    <div id="board-appearance-modal" class="overlay">
        <h2 class="text-2xl font-black mb-6 text-pink-400 uppercase tracking-widest">Board</h2>
        <div id="board-appearance-content" class="board-appearance-content w-full flex flex-col items-center max-w-[320px]">
          <div class="settings-row">
              <span class="text-sm font-bold uppercase">Shapes</span>
              <div class="flex gap-2">
                  <div id="btn-std" class="preset-chip" onpointerdown="updatePreset('standard')">Standard</div>
                  <div id="btn-cls" class="preset-chip" onpointerdown="updatePreset('classic')">Classic</div>
              </div>
          </div>
          <div class="settings-row">
              <span class="text-sm font-bold uppercase">Orientation</span>
              <div class="flex gap-2">
                  <div id="btn-vertical" class="preset-chip" onpointerdown="updateBoardOrientation('vertical')">Vertical</div>
                  <div id="btn-horizontal" class="preset-chip" onpointerdown="updateBoardOrientation('horizontal')">Horizontal</div>
              </div>
          </div>
          <div class="settings-row !flex-col !items-start gap-3 !h-auto py-4">
              <div class="flex justify-between w-full">
                  <span class="text-sm font-bold uppercase">Shape size</span>
                  <span id="shape-size-val" class="text-sm font-bold font-sans text-pink-400">90%</span>
              </div>
              <input type="range" id="shape-size-range" min="0.7" max="1" step="0.01"
                     oninput="updateShapeSizeRatio(this.value)">
          </div>
          <div class="settings-row !flex-col !items-start gap-3 !h-auto py-4">
              <div class="flex justify-between w-full">
                  <span class="text-sm font-bold uppercase">Animation Speed</span>
                  <span id="speed-val" class="text-sm font-bold font-sans text-pink-400">1.0x</span>
              </div>
              <input type="range" id="speed-range" min="0.1" max="2.0" step="0.1"
                     oninput="updateSpeedModifier(this.value)">
          </div>
          <div class="board-preview-row" id="board-preview-wrap">
              <div class="board-preview-slot">
                  <div id="board-preview-card-0" class="board-preview-card"></div>
                  <div class="board-preview-color-wrap">
                      <span class="text-[10px] uppercase text-gray-400 mb-1 block">Color 1</span>
                      <button type="button" id="board-preview-swatch-0" class="board-preview-swatch" data-color-index="0" aria-label="Choose color 1"></button>
                  </div>
              </div>
              <div class="board-preview-slot">
                  <div id="board-preview-card-1" class="board-preview-card"></div>
                  <div class="board-preview-color-wrap">
                      <span class="text-[10px] uppercase text-gray-400 mb-1 block">Color 2</span>
                      <button type="button" id="board-preview-swatch-1" class="board-preview-swatch" data-color-index="1" aria-label="Choose color 2"></button>
                  </div>
              </div>
              <div class="board-preview-slot">
                  <div id="board-preview-card-2" class="board-preview-card"></div>
                  <div class="board-preview-color-wrap">
                      <span class="text-[10px] uppercase text-gray-400 mb-1 block">Color 3</span>
                      <button type="button" id="board-preview-swatch-2" class="board-preview-swatch" data-color-index="2" aria-label="Choose color 3"></button>
                  </div>
              </div>
          </div>
          <div id="board-picker-backdrop" class="board-picker-backdrop" hidden aria-hidden="true"></div>
          <div id="board-color-picker-popover" class="board-color-picker-popover" hidden>
              <div id="hex-picker-mount" class="hex-picker-mount"></div>
              <input type="text" id="hex-input" class="hex-input" placeholder="#ffffff" maxlength="9" autocomplete="off" />
              <button type="button" class="btn-action !w-full !py-2 text-sm mt-2" id="board-picker-done">Done</button>
          </div>
        </div>
        <div class="flex gap-2 mt-4">
            <button onpointerdown="handleBoardAppearanceReset()" class="btn-action !w-32 !bg-gray-600 !shadow-[#444] text-sm">Reset All</button>
            <button onpointerdown="closeBoardAppearanceModal()" class="btn-action !w-32 text-sm">Done</button>
        </div>
    </div>

    <div id="advanced-modal" class="overlay">
        <h2 class="text-2xl font-black mb-6 text-pink-400 uppercase tracking-widest">Advanced</h2>
        <div class="w-full flex flex-col items-center">

            <div class="settings-row">
                <span class="text-sm font-bold uppercase">Auto Shuffle</span>
                <div id="toggle-auto" class="toggle-switch" onpointerdown="toggleOption('autoShuffle')"></div>
            </div>
            <div class="settings-row">
                <span class="text-sm font-bold uppercase text-[12px]">Prevent Bad Shuffle</span>
                <div id="toggle-prevent" class="toggle-switch" onpointerdown="toggleOption('preventBadShuffle')"></div>
            </div>
            <div class="settings-row">
                <span class="text-sm font-bold uppercase">Synchronized Seed</span>
                <div id="toggle-seed" class="toggle-switch" onpointerdown="toggleOption('useFixedSeed')"></div>
            </div>
            <div class="settings-row">
                <span class="text-sm font-bold uppercase">Auto Select 3rd</span>
                <div id="toggle-auto-select" class="toggle-switch" onpointerdown="toggleOption('autoSelectThird')"></div>
            </div>
            <div class="settings-row">
                <span class="text-sm font-bold uppercase">Record min sets</span>
                <input type="number" id="min-sets-input" class="input-mini" onchange="updateMinSets(this.value)">
            </div>
            <div class="settings-row">
                <span class="text-sm font-bold uppercase text-[12px]">Target Possible Sets</span>
                <input type="number" id="target-set-x-input" class="input-mini" min="0" placeholder=" " onchange="updateTargetSetX(this.value)">
            </div>
            <div class="settings-row">
                <span class="text-sm font-bold uppercase">Debug mode</span>
                <div id="toggle-debug" class="toggle-switch" onpointerdown="toggleOption('debugMode')"></div>
            </div>
        </div>
        <button onpointerdown="closeAdvancedModal()" class="btn-action !w-64 text-xl py-4 uppercase mt-8">Done</button>
    </div>

    <div id="keybinds-modal" class="overlay">
        <h2 class="text-2xl font-black mb-4 text-pink-400 uppercase tracking-widest">Keybinds</h2>
        <p class="text-[10px] text-gray-400 mb-4 uppercase text-center">Click a cell then press any key to rebind</p>

        <div class="w-full max-w-[320px]">
            <div class="kb-grid mb-4" id="kb-board-grid"></div>
            <div class="flex flex-col gap-1">
                <div class="settings-row !mb-1 !py-2 !rounded-xl">
                    <span class="text-sm font-bold uppercase">Shuffle Deck</span>
                    <div id="kb-shuffle" class="kb-cell !min-w-[80px] !h-9 !bg-[#2d2631]" onpointerdown="startKeyCapture('shuffle')"></div>
                </div>
                <div class="settings-row !mb-1 !py-2 !rounded-xl">
                    <span class="text-sm font-bold uppercase">Shuffle Board</span>
                    <div id="kb-shuffle-ex" class="kb-cell !min-w-[80px] !h-9 !bg-[#2d2631]" onpointerdown="startKeyCapture('shuffleEx')"></div>
                </div>
                <div class="settings-row !mb-1 !py-2 !rounded-xl">
                    <span class="text-sm font-bold uppercase">Finish Game</span>
                    <div id="kb-finish" class="kb-cell !min-w-[80px] !h-9 !bg-[#2d2631]" onpointerdown="startKeyCapture('finish')"></div>
                </div>
            </div>
        </div>

        <div class="flex gap-2 mt-4">
            <button onpointerdown="handleKeybindsReset()" class="btn-action !w-32 !bg-gray-600 !shadow-[#444] text-sm">Reset All</button>
            <button onpointerdown="closeKeybindsModal()" class="btn-action !w-32 text-sm">Done</button>
        </div>
    </div>

    <div id="result-modal" class="overlay">
        <div id="share-content" class="flex flex-col items-center w-full">
            <div class="more-details-btn no-export" onpointerdown="openExtraStatsModal()" data-svg-icon="MORE_DETAILS"></div>
            <div id="export-header" class="text-[10px] text-pink-400/50 font-black uppercase tracking-[0.2em] mb-1 export-only">Set Pro Trainer</div>
            <h2 id="result-title" class="text-4xl font-black mb-6 text-pink-400 uppercase tracking-widest">Result</h2>
            <div class="stat-grid mb-4">
                <div class="stat-card">
                    <div class="flex justify-between items-center w-full mb-1">
                        <span class="stat-label">Sets</span>
                        <span class="stat-label">BS</span>
                    </div>
                    <div class="flex justify-between items-baseline w-full mt-auto">
                        <span id="final-score" class="stat-value large"></span>
                        <span id="final-bad-shuffles" class="stat-value medium text-red-500">0</span>
                    </div>
                </div>
                <div class="stat-card">
                    <span class="stat-label">Total Time</span>
                    <span id="final-time" class="stat-value medium mt-auto"></span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">Avg Find</span>
                    <span id="final-avg-find" class="stat-value medium mt-auto"></span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">Fastest / Slowest</span>
                    <div id="final-ext-find" class="stat-value small-mono mt-auto"></div>
                </div>
            </div>

            <div id="final-modifiers" class="modifiers-container"></div>

            <div class="chart-container">
                <canvas id="speedChart"></canvas>
            </div>
            <div id="final-date-display" class="text-[10px] text-gray-500 font-bold uppercase mt-4 tracking-widest export-only"></div>
        </div>

        <div class="flex flex-col gap-3 items-center w-full mt-4">
            <div class="flex gap-2 items-center justify-center w-64">
                <button onpointerdown="handleRecordsButtonClick()" class="btn-action flex-1 !py-3 !text-base uppercase !bg-gray-600 !shadow-[#444]">Records</button>
                <button id="submit-online-btn" type="button" onpointerdown="handleSubmitToOnline()" class="share-btn flex-shrink-0" title="Submit to online leaderboard" aria-label="Submit to online" data-svg-icon="GLOBE"></button>
                <button onpointerdown="handleShareResult()" class="share-btn flex-shrink-0" data-svg-icon="UPLOAD"></button>
            </div>
            <button onpointerdown="handleGameReset()" class="btn-action !w-64 text-xl py-4 uppercase">Restart</button>
        </div>
    </div>

    <div id="extra-stats-modal" class="overlay" onpointerdown="closeExtraStatsModal()">
        <div class="extra-stats-modal" onpointerdown="event.stopPropagation()">
            <h3 class="text-pink-400 font-black uppercase text-center mb-4">Match Details</h3>
            <div id="extra-stats-content"></div>
            <button onpointerdown="closeExtraStatsModal()" class="btn-action !w-full !py-2 text-sm uppercase mt-4">Close</button>
        </div>
    </div>

    <div id="records-modal" class="overlay">
        <div class="records-modal-inner">
            <div class="records-modal-scroll">
                <div class="flex items-center justify-center gap-2 w-full mb-6">
                    <h2 class="text-2xl font-black text-pink-400 uppercase tracking-widest">Top Scores</h2>
                    <button type="button" id="open-online-records-btn" onpointerdown="openOnlineRecordsModal()" class="p-1.5 rounded-lg text-gray-400 hover:text-pink-400 hover:bg-white/10 transition-colors" title="Online records" aria-label="Online records" data-svg-icon="GLOBE"></button>
                </div>
                <div id="records-container" class="records-list"></div>
            </div>
            <button onpointerdown="closeRecordsModal()" class="btn-action records-modal-back">Back</button>
        </div>
    </div>

    <div id="online-settings-modal" class="overlay">
        <h2 class="text-2xl font-black mb-6 text-pink-400 uppercase tracking-widest">Online</h2>
        <div class="w-full flex flex-col items-center max-w-[320px]">
            <div class="settings-row">
                <span class="text-sm font-bold uppercase">Nickname</span>
                <input type="text" id="online-settings-nickname" class="input-online" style="width: 167px;" placeholder="Your nickname" maxlength="16" />
            </div>
            <div class="settings-row">
                <span class="text-sm font-bold uppercase text-[12px]">Best result per player</span>
                <div id="toggle-online-best-per-player" class="toggle-switch" onpointerdown="toggleOnlineBestPerPlayer()"></div>
            </div>
            <div class="settings-row !flex-col !items-stretch !h-auto gap-2">
                <span class="text-sm font-bold uppercase">Show records only from</span>
                <input type="text" id="online-settings-filter" class="input-online !w-full" placeholder="nick1, nick2, … Leave empty for all." />
            </div>
        </div>
        <button onpointerdown="closeOnlineSettingsModal()" class="btn-action !w-64 text-xl py-4 uppercase mt-8">Done</button>
    </div>

    <div id="online-records-modal" class="overlay">
        <div class="records-modal-inner">
            <div class="records-modal-scroll">
                <h2 class="text-2xl font-black mb-6 text-pink-400 uppercase tracking-widest">Online Records</h2>
                <div id="online-records-container" class="records-list"></div>
            </div>
            <button onpointerdown="closeOnlineRecordsModal()" class="btn-action records-modal-back">Back</button>
        </div>
    </div>
</div>

<script src="constants.js"></script>
<script src="storage-module.js"></script>
<script src="state.js"></script>
<script src="resizer.js"></script>
<script src="utilities.js"></script>
<script src="online-leaderboard.js"></script>
<script src="modal-management.js"></script>
<script src="graphics-rendering.js"></script>
<script src="settings.js"></script>
<script src="color-picker.js"></script>
<script src="set-math.js"></script>
<script src="tps-logic.js"></script>
<script src="game-logic.js"></script>
<script src="results-stats.js"></script>
<script src="keybinds.js"></script>
<script src="event-listeners.js"></script>
<script src="timer.js"></script>
<script>
  (function() {
    document.querySelectorAll('[data-svg-icon]').forEach(function(el) {
      var key = el.getAttribute('data-svg-icon');
      if (typeof SVG_ICONS !== 'undefined' && SVG_ICONS[key]) el.innerHTML = SVG_ICONS[key];
    });
  })();
  (function() {
    var boardEl = document.getElementById('board');
    if (boardEl) boardEl.style.setProperty('--shape-size-ratio', String(config.shapeSizeRatio));
  })();
  initNewDeckAndBoard();
  updateColors();
  syncSettingsUI();
  syncGameModifiers();
  updateUI();
</script>
</body>
</html>
