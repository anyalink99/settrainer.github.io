<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Set Pro Training</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * { box-sizing: border-box; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: #1a161d; 
            color: white; 
            font-family: sans-serif; 
            overflow: hidden; 
            height: 100vh; height: 100dvh; 
            display: flex; 
            justify-content: center;
            margin: 0; 
        }

        .app-container {
            width: 500px; 
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #2d2631;
            padding: 10px 20px calc(10px + env(safe-area-inset-bottom)) 20px;
            position: relative;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        .fixed-core {
            width: 100%;
            max-width: 460px;
            display: flex;
            flex-direction: column;
            height: 100%;
            z-index: 30;
        }
        
        #board { 
            display: grid; grid-template-columns: repeat(4, 1fr); 
            gap: 8px; width: 100%; margin: 0 auto;
            flex-grow: 1; 
            align-content: center;
            min-height: 0;
            z-index: 40; /* Выше зоны свайпа для кликов */
        }

        .hud-layer {
            position: absolute;
            top: 10px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
            z-index: 70; /* Максимальный приоритет */
        }
        .hud-left, .hud-right { pointer-events: auto; }

        .settings-edge-container {
            position: absolute;
            right: 20px;
            bottom: 80px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            z-index: 80; /* Выше зоны свайпа */
        }
        
        .card-slot { aspect-ratio: 2/3; width: 100%; position: relative; }

        .card { 
            background: white; border-radius: 8px; 
            width: 100%; height: 100%; display: flex; flex-direction: column; 
            justify-content: center; align-items: center;
            padding: 2px; 
            transition: transform 0.15s cubic-bezier(0.2, 0, 0.2, 1), opacity 0.1s ease, border-color 0.15s ease;
            border: 3px solid transparent; position: absolute; inset: 0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
            transform-origin: center center;
            will-change: transform, opacity;
            z-index: 1;
            overflow: hidden;
            pointer-events: auto;
        }

        .card.anim-in { animation: cardPop 0.18s cubic-bezier(0.175, 0.885, 0.32, 1.1); }
        .card.selected { border-color: #a34e78 !important; transform: scale(0.88) !important; z-index: 2; }
        .card.anim-out { opacity: 0 !important; transform: scale(0) rotate(8deg) !important; transition: all 0.1s ease-in !important; }
        
        @keyframes cardJump {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .card.jumping { animation: cardJump 0.2s ease-out; }

        @keyframes cardPop { 0% { opacity: 0; transform: scale(0.6); } 100% { opacity: 1; transform: scale(1); } }
        
        @keyframes fadeScaleIn {
            from { opacity: 0; transform: scale(0.9) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        @keyframes fadeScaleOut {
            from { opacity: 1; transform: scale(1) translateY(0); }
            to { opacity: 0; transform: scale(1.05) translateY(-20px); }
        }

        .overlay.show { display: flex; animation: fadeScaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .overlay.hide { display: flex; animation: fadeScaleOut 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        @keyframes toastFly {
            0% { opacity: 0; transform: translate(-50%, 0) scale(0.5); }
            20% { opacity: 1; transform: translate(-50%, -100px) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -250px) scale(1); }
        }

        .bad-shuffle-toast {
            position: fixed; left: 50%; bottom: 80px;
            color: #ff4d4d; font-weight: 900; font-size: 1.5rem;
            text-transform: uppercase; pointer-events: none; z-index: 1000;
            animation: toastFly 0.8s cubic-bezier(0.22, 1, 0.36, 1) forwards;
            text-shadow: 0 0 15px rgba(255,0,0,0.5);
        }

        .btn-action {
            background-color: #a34e78; border-radius: 20px;
            padding: 12px 0; width: 48%; font-weight: bold; text-align: center;
            box-shadow: 0 4px 0 #7a3a5a;
            transition: all 0.2s;
            user-select: none;
            flex-shrink: 0;
            z-index: 60;
            pointer-events: auto;
        }
        .btn-action:active { transform: translateY(2px); box-shadow: 0 2px 0 #7a3a5a; }
        .btn-action.locked { background-color: #4a3f50; box-shadow: 0 4px 0 #2d2631; color: #a34e78; }

        .shape-svg-classic { width: 95%; height: 50px; flex-shrink: 0; }
        .shape-svg-classic.oval { margin-top: -13.2px; }
        .shape-svg-classic.diamond { margin-top: -14.9px; }
        .shape-svg-classic.wave { height: 56px; margin-top: -21px; }
        .shape-svg-classic:first-child { margin-top: 0 !important; }

        .overlay { 
            display: none; position: absolute; inset: 0; 
            background: rgba(45, 38, 49, 0.98); backdrop-filter: blur(15px);
            z-index: 100; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px;
        }

        .settings-btn {
            background: #443a4a; width: 40px; height: 40px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 5px; cursor: pointer;
            z-index: 90;
        }

        .settings-row {
            width: 100%; max-width: 320px; background: #3d3442; 
            padding: 12px; border-radius: 15px; margin-bottom: 8px;
            display: flex; justify-content: space-between; align-items: center;
            border: 1px solid #5a4d61;
        }

        .toggle-switch {
            position: relative; width: 50px; height: 26px;
            background: #2d2631; border-radius: 13px; transition: 0.3s;
            cursor: pointer; border: 2px solid #5a4d61;
        }
        .toggle-switch.active { background: #a34e78; border-color: #a34e78; }
        .toggle-switch::after {
            content: ''; position: absolute; width: 18px; height: 18px;
            background: white; border-radius: 50%; top: 2px; left: 2px;
            transition: 0.2s cubic-bezier(0.18, 0.89, 0.35, 1.15);
        }
        .toggle-switch.active::after { left: 26px; }

        .preset-chip {
            padding: 6px 12px; border-radius: 10px; background: #2d2631;
            font-size: 12px; font-weight: bold; color: #888; border: 1px solid #5a4d61;
            cursor: pointer; transition: all 0.2s; user-select: none;
        }
        .preset-chip.active { background: #a34e78; color: white; border-color: #a34e78; }
        .preset-chip:active { transform: scale(0.95); }

        @keyframes chipPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .chip-animate { animation: chipPulse 0.25s ease-out; }

        .records-list {
            width: 100%; max-width: 350px; height: 320px;
            overflow-y: auto; 
            touch-action: pan-y !important;
            -webkit-overflow-scrolling: touch;
            padding-right: 5px;
            scrollbar-gutter: stable;
        }
        .record-item {
            background: #3d3442; border-radius: 12px; padding: 10px 15px;
            margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between;
            border: 1px solid #5a4d61;
        }
        .record-info { font-size: 0.85rem; color: #ccc; pointer-events: none; }
        .record-val { font-weight: bold; color: #ec4899; font-size: 1.1rem; }
        .btn-del { color: #ff4d4d; padding: 10px; opacity: 0.6; cursor: pointer; }
        .btn-del:active { opacity: 1; transform: scale(1.1); }
        .records-list::-webkit-scrollbar { width: 4px; }
        .records-list::-webkit-scrollbar-thumb { background: #a34e78; border-radius: 10px; }

        .input-mini {
            background: #2d2631; border: 1px solid #5a4d61; border-radius: 8px;
            width: 50px; text-align: center; color: white; font-weight: bold; padding: 4px 0;
        }

        .det-panel {
            background: #3d3442; border: 1px solid #5a4d61;
            border-radius: 6px; width: 32px; height: 42px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; overflow: hidden;
        }
        .det-label { font-size: 7px; text-transform: uppercase; color: #888; margin-top: 1px; }
        .det-val { font-weight: 900; font-size: 14px; line-height: 1; color: #ec4899; }

        .bottom-actions {
            padding: 10px 0;
            display: flex;
            justify-content: space-between;
            width: 100%;
            position: relative;
            z-index: 60;
        }
        
        .seed-indicator {
            font-size: 10px; color: #a34e78; font-weight: bold;
            text-transform: uppercase; margin-top: 2px;
        }

        .stat-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
            width: 100%; max-width: 350px;
        }
        .stat-card {
            background: rgba(255,255,255,0.05); 
            padding: 10px 14px; 
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            height: 64px;
        }
        .stat-label { font-size: 9px; color: #9ca3af; text-transform: uppercase; font-weight: 700; letter-spacing: 0.05em; margin-bottom: 5px; display: block; line-height: 1; }
        .stat-value { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-weight: 700; line-height: 1; }
        .stat-value.large { font-size: 26px; color: #ec4899; }
        .stat-value.medium { font-size: 22px; color: white; }
        .stat-value.small-mono { font-size: 13px; color: white; line-height: 1.1; }

        .chart-container {
            width: 100%;
            max-width: 350px;
            height: 140px;
            margin-top: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            padding: 10px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        #swipe-zone {
            position: absolute; 
            top: 100px;
            bottom: 150px;
            left: 10px; 
            right: 55px;
            z-index: 35;
            touch-action: none;
            background: transparent;
            pointer-events: none;
        }
        
        .share-btn {
            background: #4b5563; border-radius: 12px;
            width: 44px; height: 50px; display: flex; align-items: center; justify-content: center;
            color: white; box-shadow: 0 4px 0 #374151; transition: all 0.2s;
        }
        .share-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #374151; }

        .export-only { display: none; }

        .kb-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; width: 100%;
        }
        .kb-cell {
            background: #2d2631; border: 1px solid #5a4d61; border-radius: 8px;
            min-height: 45px; display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 0.875rem; color: #ec4899; text-transform: uppercase; cursor: pointer;
            transition: background 0.2s, color 0.2s, border-color 0.2s;
            padding: 4px 8px; text-align: center;
        }
        .kb-cell:active { background: #a34e78; color: white; }
        .kb-cell.waiting { animation: pulse 0.6s infinite; background: #ec4899; color: white; border-color: white; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        @keyframes conflictPulse {
            0% { background: #2d2631; border-color: #5a4d61; }
            50% { background: #ef4444; border-color: white; }
            100% { background: #2d2631; border-color: #5a4d61; }
        }
        .kb-conflict { animation: conflictPulse 0.4s ease-out; }

        @media (pointer: coarse) {
            .desktop-only { display: none !important; }
        }

        .resizer {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 8px;
            cursor: ew-resize;
            background: transparent;
            z-index: 50;
        }
        .resizer-l { left: 0; }
        .resizer-r { right: 0; }

    </style>
</head>
<body>

<div id="app-container" class="app-container">
    <div class="resizer resizer-l" id="resizer-l"></div>
    <div class="resizer resizer-r" id="resizer-r"></div>

    <svg style="position: absolute; width: 0; height: 0;">
        <defs id="svg-defs"></defs>
    </svg>

    <div id="swipe-zone"></div>

    <div class="hud-layer">
        <div class="hud-left">
            <div id="possible-area" class="flex flex-col gap-1">
                <div id="possible-label" class="text-lg font-bold">Possible: <span id="possible-count" class="text-pink-400">0</span></div>
                <div id="detailed-possible" class="flex gap-1 transition-opacity duration-300">
                    <div class="det-panel"><span class="det-val" id="det-4">0</span><span class="det-label">Diff</span></div>
                    <div class="det-panel"><span class="det-val" id="det-3">0</span><span class="det-label">1 Sm</span></div>
                    <div class="det-panel"><span class="det-val" id="det-2">0</span><span class="det-label">2 Sm</span></div>
                    <div class="det-panel"><span class="det-val" id="det-1">0</span><span class="det-label">3 Sm</span></div>
                </div>
            </div>
        </div>
        <div class="hud-right">
            <div class="flex flex-col items-end">
                <div id="timer" class="font-mono bg-black/20 px-3 py-1 rounded text-lg font-bold">00:00</div>
                <div id="seed-label" class="seed-indicator" style="display:none">Fixed Seed ON</div>
            </div>
        </div>
    </div>

    <div class="settings-edge-container">
        <div class="settings-btn" onpointerdown="toggleSettings(true)">
            <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.91,7.62,6.29L5.23,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.72,8.87 c-0.11,0.2-0.06,0.47,0.12,0.61l2.03,1.58C4.84,11.36,4.81,11.66,4.81,12c0,0.33,0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.5c-1.93,0-3.5-1.57-3.5-3.5 s1.57-3.5,3.5-3.5s3.5,1.57,3.5,3.5S13.93,15.5,12,15.5z"/></svg>
        </div>
        <div class="text-gray-300 text-sm font-medium">Sets: <span id="current-score" class="text-pink-400 font-bold">0</span></div>
        <div class="text-gray-400 text-xs">Cards: <span id="deck-count">0</span></div>
    </div>

    <div class="fixed-core">
        <div class="h-[15px] flex-shrink-0"></div> <div id="board">
            <div class="card-slot"></div><div class="card-slot"></div><div class="card-slot"></div><div class="card-slot"></div>
            <div class="card-slot"></div><div class="card-slot"></div><div class="card-slot"></div><div class="card-slot"></div>
            <div class="card-slot"></div><div class="card-slot"></div><div class="card-slot"></div><div class="card-slot"></div>
        </div>

        <div class="bottom-actions">
            <button onpointerdown="finishGame()" class="btn-action">Finish</button>
            <button id="shuffle-btn" onpointerdown="handleShuffleClick()" class="btn-action">Shuffle</button>
        </div>
    </div>

    <div id="settings-modal" class="overlay">
        <h2 class="text-2xl font-black mb-6 text-pink-400 uppercase tracking-widest">Settings</h2>
        <div class="w-full flex flex-col items-center">
            <div class="settings-row desktop-only">
                <span class="text-sm font-bold uppercase">Controls</span>
                <button onpointerdown="openKeybinds()" class="preset-chip active !bg-indigo-600 !border-indigo-400">Edit Keybinds</button>
            </div>
            <div class="settings-row">
                <span class="text-sm font-bold uppercase">Shapes</span>
                <div class="flex gap-2">
                    <div id="btn-std" class="preset-chip" onpointerdown="setShape('standard')">Standard</div>
                    <div id="btn-cls" class="preset-chip" onpointerdown="setShape('classic')">Classic</div>
                </div>
            </div>
            <div class="settings-row">
                <span class="text-sm font-bold uppercase">Show Possible</span>
                <div id="toggle-possible" class="toggle-switch" onpointerdown="toggleOption('showPossible')"></div>
            </div>
            <div id="row-detailed" class="settings-row transition-opacity">
                <span class="text-sm font-bold uppercase text-[12px]">Detailed Possible</span>
                <div id="toggle-detailed" class="toggle-switch" onpointerdown="toggleOption('showDetailedPossible')"></div>
            </div>
            <div class="settings-row">
                <span class="text-sm font-bold uppercase">Auto Shuffle</span>
                <div id="toggle-auto" class="toggle-switch" onpointerdown="toggleOption('autoShuffle')"></div>
            </div>
            <div class="settings-row">
                <span class="text-sm font-bold uppercase">Auto Select 3rd</span>
                <div id="toggle-auto-select" class="toggle-switch" onpointerdown="toggleOption('autoSelectThird')"></div>
            </div>
            <div class="settings-row">
                <span class="text-sm font-bold uppercase">Fixed Seed (min)</span>
                <div id="toggle-seed" class="toggle-switch" onpointerdown="toggleOption('useFixedSeed')"></div>
            </div>
            <div class="settings-row">
                <span class="text-sm font-bold uppercase text-[12px]">Prevent Bad Shuffle</span>
                <div id="toggle-prevent" class="toggle-switch" onpointerdown="toggleOption('preventBadShuffle')"></div>
            </div>
            <div class="settings-row">
                <span class="text-sm font-bold uppercase">Record min sets</span>
                <input type="number" id="min-sets-input" class="input-mini" onchange="setMinSets(this.value)">
            </div>
        </div>
        <button onpointerdown="toggleSettings(false)" class="btn-action !w-64 text-xl py-4 uppercase mt-4">Close</button>
    </div>

    <div id="keybinds-modal" class="overlay">
        <h2 class="text-2xl font-black mb-4 text-pink-400 uppercase tracking-widest">Keybinds</h2>
        <p class="text-[10px] text-gray-400 mb-4 uppercase text-center">Click a cell then press any key to rebind</p>
        
        <div class="w-full max-w-[320px]">
            <div class="kb-grid mb-4" id="kb-board-grid">
                </div>
            
            <div class="flex flex-col gap-1">
                <div class="settings-row !mb-1 !py-2 !rounded-xl">
                    <span class="text-sm font-bold uppercase">Shuffle Deck</span>
                    <div id="kb-shuffle" class="kb-cell !min-w-[80px] !h-9 !bg-[#2d2631]" onclick="startCapture('shuffle')"></div>
                </div>
                <div class="settings-row !mb-1 !py-2 !rounded-xl">
                    <span class="text-sm font-bold uppercase">Shuffle Board</span>
                    <div id="kb-shuffle-ex" class="kb-cell !min-w-[80px] !h-9 !bg-[#2d2631]" onclick="startCapture('shuffleEx')"></div>
                </div>
                <div class="settings-row !mb-1 !py-2 !rounded-xl">
                    <span class="text-sm font-bold uppercase">Finish Game</span>
                    <div id="kb-finish" class="kb-cell !min-w-[80px] !h-9 !bg-[#2d2631]" onclick="startCapture('finish')"></div>
                </div>
            </div>
        </div>
        
        <div class="flex gap-2 mt-4">
            <button onpointerdown="resetKeybinds()" class="btn-action !w-32 !bg-gray-600 !shadow-[#444] text-sm">Reset All</button>
            <button onpointerdown="closeKeybinds()" class="btn-action !w-32 text-sm">Done</button>
        </div>
    </div>

    <div id="result-modal" class="overlay">
        <div id="share-content" class="flex flex-col items-center w-full">
            <div id="export-header" class="text-[10px] text-pink-400/50 font-black uppercase tracking-[0.2em] mb-1 export-only">Set Pro Trainer</div>
            <h2 id="result-title" class="text-4xl font-black mb-6 text-pink-400 uppercase tracking-widest">Result</h2>
            <div class="stat-grid mb-4">
                <div class="stat-card">
                    <div class="flex justify-between items-center w-full mb-1">
                        <span class="stat-label">Sets</span>
                        <span class="stat-label">BS</span>
                    </div>
                    <div class="flex justify-between items-baseline w-full mt-auto">
                        <span id="final-score" class="stat-value large"></span>
                        <span id="final-bad-shuffles" class="stat-value medium text-red-500">0</span>
                    </div>
                </div>
                <div class="stat-card">
                    <span class="stat-label">Total Time</span>
                    <span id="final-time" class="stat-value medium mt-auto"></span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">Avg Find</span>
                    <span id="final-avg-find" class="stat-value medium mt-auto"></span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">Fastest / Slowest</span>
                    <div id="final-ext-find" class="stat-value small-mono mt-auto"></div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="speedChart"></canvas>
            </div>
            <div id="final-date-display" class="text-[10px] text-gray-500 font-bold uppercase mt-4 tracking-widest export-only"></div>
        </div>

        <div class="flex flex-col gap-3 items-center w-full mt-4">
            <div class="flex gap-2 w-64">
                <button onpointerdown="openRecords()" class="btn-action flex-grow text-xl py-4 uppercase !bg-gray-600 !shadow-[#444]">Records</button>
                <button onpointerdown="shareResult()" class="share-btn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
                </button>
            </div>
            <button onpointerdown="resetGame()" class="btn-action !w-64 text-xl py-4 uppercase">Restart</button>
        </div>
    </div>

    <div id="records-modal" class="overlay">
        <h2 class="text-2xl font-black mb-6 text-pink-400 uppercase tracking-widest">Top Scores</h2>
        <div id="records-container" class="records-list"></div>
        <button onpointerdown="closeRecords()" class="btn-action !w-64 text-xl py-4 uppercase mt-6">Back</button>
    </div>
</div>

<script>
    const GAME_COLORS = ['#fd0000', '#01a43b', '#0000fe'];
    
    const KEY_MAP = {
        'й':'q','ц':'w','у':'e','к':'r','е':'t','н':'y','г':'u','ш':'i','щ':'o','з':'p','х':'[','ъ':']',
        'ф':'a','ы':'s','в':'d','а':'f','п':'g','р':'h','о':'j','л':'k','д':'l','ж':';','э':'\'',
        'я':'z','ч':'x','с':'c','м':'v','и':'b','т':'n','ь':'m','б':',','ю':'.'
    };

    let config = {
        preset: localStorage.getItem('set_shape_preset') || 'standard',
        showPossible: localStorage.getItem('set_show_possible') !== 'false', 
        showDetailedPossible: localStorage.getItem('set_show_detailed') === 'true',
        autoShuffle: localStorage.getItem('set_auto_shuffle') !== 'false',
        autoSelectThird: localStorage.getItem('set_auto_select_third') === 'true',
        preventBadShuffle: localStorage.getItem('set_prevent_bad_shuffle') === 'true',
        useFixedSeed: localStorage.getItem('set_use_fixed_seed') === 'true',
        minSetsToRecord: parseInt(localStorage.getItem('set_min_sets') || '23')
    };

    const DEFAULT_BINDS = {
        board: ['e', 'r', 'i', 'o', 'd', 'f', 'j', 'k', 'c', 'v', 'n', 'm'],
        shuffle: 'backspace',
        shuffleEx: ' ',
        finish: 'enter'
    };
    let binds = JSON.parse(localStorage.getItem('set_keybinds')) || JSON.parse(JSON.stringify(DEFAULT_BINDS));
    let isCapturingKey = null;

    let deck = [], board = [], selected = [], collectedSets = 0, badShuffles = 0;
    let startTime = Date.now(), isAnimating = false, isGameOver = false, isBtnLocked = false;
    let setTimestamps = [], possibleHistory = []; 
    let speedChartInstance = null;

    const appContainer = document.getElementById('app-container');
    const resizerL = document.getElementById('resizer-l');
    const resizerR = document.getElementById('resizer-r');
    let isResizing = false;

    const savedWidth = localStorage.getItem('set_app_width');
    if (savedWidth) appContainer.style.width = savedWidth + 'px';

    function initResize(e) {
        isResizing = true;
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', stopResize);
        document.body.style.cursor = 'ew-resize';
    }

    function handleMouseMove(e) {
        if (!isResizing) return;
        const centerX = window.innerWidth / 2;
        const offset = Math.abs(e.clientX - centerX);
        let newWidth = offset * 2;
        if (newWidth > window.innerWidth - 30) newWidth = window.innerWidth;
        appContainer.style.width = newWidth + 'px';
        localStorage.setItem('set_app_width', Math.floor(newWidth));
    }

    function stopResize() {
        isResizing = false;
        document.removeEventListener('mousemove', handleMouseMove);
        document.removeEventListener('mouseup', stopResize);
        document.body.style.cursor = '';
    }

    resizerL.addEventListener('mousedown', initResize);
    resizerR.addEventListener('mousedown', initResize);

    function mulberry32(a) {
        return function() {
            let t = a += 0x6D2B79F5;
            t = Math.imul(t ^ t >>> 15, t | 1);
            t ^= t + Math.imul(t ^ t >>> 7, t | 61);
            return ((t ^ t >>> 14) >>> 0) / 4294967296;
        }
    }

    function formatTime(ms, showMs = false) {
        const totalSec = Math.floor(ms / 1000);
        const m = Math.floor(totalSec / 60);
        const s = totalSec % 60;
        let res = `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        if (showMs) {
            const remainder = Math.floor((ms % 1000) / 10);
            res += `.${String(remainder).padStart(2, '0')}`;
        }
        return res;
    }

    function updateColors() {
        const defs = document.getElementById('svg-defs');
        const isStd = config.preset === 'standard';
        const step = isStd ? 3 : 1.5;
        const sWidth = isStd ? 1.2 : 0.6;
        const xOffset = isStd ? 1 : 0;
        defs.innerHTML = GAME_COLORS.map((c, i) => 
            `<pattern id="s-${i}" patternUnits="userSpaceOnUse" width="${step}" height="${step}">
                <line x1="${xOffset}" y1="0" x2="${xOffset}" y2="${step}" stroke="${c}" stroke-width="${sWidth}" />
            </pattern>`
        ).join('');
        for(let i=0; i<12; i++) updateSlot(i, false);
    }

    function getShapeSVG(card) {
        const color = GAME_COLORS[card.c];
        let fill = card.f === 0 ? 'none' : color;
        if (card.f === 1) fill = `url(#s-${card.c})`;
        let strokeW = config.preset === 'classic' ? (card.f === 1 ? 1 : 1.7) : 1.8;

        if (config.preset === 'standard') {
            const shapes = [
                `<rect x="4" y="4" width="24" height="24" rx="1" stroke="${color}" stroke-width="1.8" fill="${fill}" />`,
                `<circle cx="16" cy="16" r="12" stroke="${color}" stroke-width="1.8" fill="${fill}" />`,
                `<polygon points="16,4 29,27 3,27" stroke="${color}" stroke-width="1.8" fill="${fill}" stroke-linejoin="round" />`
            ];
            return `<svg style="width:36px; height:36px" viewBox="0 0 32 32">${shapes[card.s]}</svg>`;
        } else {
            const waveD = "M29.5,12 C30.8,14.5 30.8,17.2 30.2,19.9 C29.7,22.2 28,23 26,22 C25.4,21.7 24.8,21.4 24.3,21.1 C21.7,19.5 19,19.3 16.1,20.4 C13.4,21.5 10.6,21.6 7.8,20.8 C3.3,19.4 0.4,14.6 1.4,10.2 C2,7.7 3.7,7 5.9,8.2 C6.2,8.4 6.5,8.6 6.8,8.8 C9.7,10.6 12.7,11.2 16,9.9 C17.3,9.3 18.7,8.9 20,8.6 C24,7.6 27.5,8.9 29.5,12 Z";
            let inner = '';
            let extraClass = '';
            if (card.s === 0) {
                inner = `<polygon transform="translate(16,16) scale(1.08) translate(-16,-16)" points="1,16 16,8.5 31,16 16,23.5" stroke="${color}" stroke-width="${strokeW}" fill="${fill}" stroke-linejoin="round" />`;
                extraClass = 'diamond';
            } else if (card.s === 1) {
                inner = `<rect transform="translate(16,16) scale(1.08, 1.16) translate(-16,-16)" x="1" y="9.5" width="30" height="13" rx="6.5" stroke="${color}" stroke-width="${strokeW}" fill="${fill}" />`;
                extraClass = 'oval';
            } else {
                inner = `<path transform="translate(16,16) scale(1.08) translate(-16,-16)" d="${waveD}" stroke="${color}" stroke-width="${strokeW}" fill="${fill}" stroke-linejoin="round" />`;
                extraClass = 'wave';
            }
            return `<svg class="shape-svg-classic ${extraClass}" viewBox="0 0 32 32">${inner}</svg>`;
        }
    }

    function updateSlot(i, animateIn = false) {
        const slot = document.getElementById('board').children[i];
        const card = board[i];
        if (!slot) return;
        slot.innerHTML = '';
        if (card) {
            const el = document.createElement('div');
            el.className = 'card' + (animateIn ? ' anim-in' : '');
            if (config.preset === 'standard') el.style.gap = ['0px', '9px', '3px'][card.n];
            for (let n=0; n<=card.n; n++) el.innerHTML += getShapeSVG(card);
            el.onpointerdown = (e) => { e.preventDefault(); toggleSelect(i, el); };
            slot.appendChild(el);
        }
    }

    async function toggleSettings(show) {
        const modal = document.getElementById('settings-modal');
        if (show) {
            syncSettingsUI();
            modal.classList.remove('hide');
            modal.classList.add('show');
        } else {
            modal.classList.add('hide');
            await new Promise(r => setTimeout(r, 200));
            modal.classList.remove('show', 'hide');
        }
    }

    function syncSettingsUI() {
        document.getElementById('btn-std').className = `preset-chip ${config.preset === 'standard' ? 'active' : ''}`;
        document.getElementById('btn-cls').className = `preset-chip ${config.preset === 'classic' ? 'active' : ''}`;
        document.getElementById('toggle-possible').classList.toggle('active', config.showPossible);
        const rowDet = document.getElementById('row-detailed');
        rowDet.style.opacity = config.showPossible ? '1' : '0.3';
        rowDet.style.pointerEvents = config.showPossible ? 'auto' : 'none';
        document.getElementById('toggle-detailed').classList.toggle('active', config.showDetailedPossible);
        document.getElementById('toggle-auto').classList.toggle('active', config.autoShuffle);
        document.getElementById('toggle-auto-select').classList.toggle('active', config.autoSelectThird);
        document.getElementById('toggle-prevent').classList.toggle('active', config.preventBadShuffle);
        document.getElementById('toggle-seed').classList.toggle('active', config.useFixedSeed);
        document.getElementById('min-sets-input').value = config.minSetsToRecord;
        document.getElementById('seed-label').style.display = config.useFixedSeed ? 'block' : 'none';
    }

    function setShape(p) {
        if (config.preset === p) return;
        config.preset = p;
        localStorage.setItem('set_shape_preset', p);
        const activeBtn = p === 'standard' ? document.getElementById('btn-std') : document.getElementById('btn-cls');
        activeBtn.classList.add('chip-animate');
        activeBtn.addEventListener('animationend', () => { activeBtn.classList.remove('chip-animate'); }, { once: true });
        updateColors();
        syncSettingsUI();
    }

    function toggleOption(key) {
        config[key] = !config[key];
        const storageKey = 'set_' + key.replace(/[A-Z]/g, letter => `_${letter.toLowerCase()}`);
        localStorage.setItem(storageKey, config[key]);
        syncSettingsUI();
        if (key === 'useFixedSeed') {
            initNewDeckAndBoard();
            resetStats();
            updateUI();
        } else {
            updateUI();
        }
    }

    function setMinSets(val) {
        const num = parseInt(val) || 0;
        config.minSetsToRecord = num;
        localStorage.setItem('set_min_sets', num);
    }

    function createDeck() {
        const d = [];
        for (let c=0; c<3; c++) for (let s=0; s<3; s++) for (let f=0; f<3; f++) for (let n=0; n<3; n++) d.push({c,s,f,n});
        let randomFunc = Math.random;
        if (config.useFixedSeed) {
            const now = new Date();
            const seedStr = `${now.getFullYear()}${now.getMonth()}${now.getDate()}${now.getHours()}${now.getMinutes()}`;
            randomFunc = mulberry32(parseInt(seedStr));
        }
        for (let i = d.length - 1; i > 0; i--) {
            const j = Math.floor(randomFunc() * (i + 1));
            [d[i], d[j]] = [d[j], d[i]];
        }
        return d;
    }

    function analyzePossibleSets() {
        let stats = { total: 0, 1: 0, 2: 0, 3: 0, 4: 0 };
        for(let i=0; i<board.length; i++) {
            for(let j=i+1; j<board.length; j++) {
                for(let k=j+1; k<board.length; k++) {
                    if(board[i] && board[j] && board[k]) {
                        let diffCount = 0;
                        let isSet = true;
                        ['c','s','f','n'].forEach(p => {
                            if ((board[i][p]+board[j][p]+board[k][p])%3 !== 0) isSet = false;
                            if (board[i][p] !== board[j][p]) diffCount++;
                        });
                        if (isSet) { stats.total++; stats[diffCount]++; }
                    }
                }
            }
        }
        return stats;
    }

    function updateUI() {
        const stats = analyzePossibleSets();
        possibleHistory.push(stats.total);
        document.getElementById('deck-count').innerText = deck.length;
        document.getElementById('current-score').innerText = collectedSets;
        document.getElementById('possible-count').innerText = stats.total;
        document.getElementById('possible-label').style.opacity = config.showPossible ? '1' : '0';
        const detContainer = document.getElementById('detailed-possible');
        detContainer.style.opacity = (config.showPossible && config.showDetailedPossible) ? '1' : '0';
        document.getElementById('det-4').innerText = stats[4];
        document.getElementById('det-3').innerText = stats[3];
        document.getElementById('det-2').innerText = stats[2];
        document.getElementById('det-1').innerText = stats[1];
        if (stats.total === 0 && config.autoShuffle && deck.length > 0 && !isAnimating && !isGameOver) {
            setTimeout(() => shuffleBoard(true), 500);
        }
    }

    function showToast(text) {
        const toast = document.createElement('div');
        toast.className = 'bad-shuffle-toast';
        toast.innerText = text;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 800);
    }

    async function toggleSelect(idx, el) {
        if (isAnimating || isGameOver) return;
        
        if (selected.includes(idx)) {
            selected = selected.filter(i => i !== idx);
            el.classList.remove('selected');
            return;
        }

        selected.push(idx); 
        el.classList.add('selected');

        if (selected.length === 2 && config.autoSelectThird) {
            const c1 = board[selected[0]];
            const c2 = board[selected[1]];
            
            const target = {};
            ['c','s','f','n'].forEach(p => {
                target[p] = (3 - (c1[p] + c2[p]) % 3) % 3;
            });

            let thirdIdx = -1;
            for(let i=0; i<board.length; i++) {
                if (!board[i] || selected.includes(i)) continue;
                if (['c','s','f','n'].every(p => board[i][p] === target[p])) {
                    thirdIdx = i;
                    break;
                }
            }

            if (thirdIdx !== -1) {
                const thirdEl = document.getElementById('board').children[thirdIdx].querySelector('.card');
                selected.push(thirdIdx);
                thirdEl.classList.add('selected');
            } else {
                isAnimating = true;
                await new Promise(r => setTimeout(r, 150));
                selected.forEach(i => document.getElementById('board').children[i].querySelector('.card')?.classList.remove('selected'));
                selected = [];
                isAnimating = false;
                return;
            }
        }

        if (selected.length === 3) {
            isAnimating = true;
            const sIdx = [...selected];
            const cards = sIdx.map(i => board[i]);
            const isCorrect = ['c','s','f','n'].every(p => (cards[0][p] + cards[1][p] + cards[2][p]) % 3 === 0);
            if (isCorrect) {
                collectedSets++;
                setTimestamps.push(startTime + (Date.now() - startTime));
                sIdx.forEach(i => document.getElementById('board').children[i].querySelector('.card')?.classList.add('anim-out'));
                await new Promise(r => setTimeout(r, 70));
                sIdx.forEach(i => { board[i] = deck.length > 0 ? deck.pop() : null; updateSlot(i, true); });
                selected = []; 
                isAnimating = false; 
                updateUI();
                if (collectedSets >= 23 && analyzePossibleSets().total === 0 && !isGameOver) {
                    setTimeout(() => finishGame(), 300);
                }
            } else {
                await new Promise(r => setTimeout(r, 150));
                sIdx.forEach(i => document.getElementById('board').children[i].querySelector('.card')?.classList.remove('selected'));
                selected = [];
                isAnimating = false;
            }
        }
    }

    function handleShuffleClick() {
        if (isAnimating || isGameOver || isBtnLocked) return;
        const possibleCount = analyzePossibleSets().total;
        if (possibleCount > 0) {
            badShuffles++;
            updateUI();
            if (!config.showPossible && !config.autoShuffle) showToast('bad shuffle!');
            if (config.preventBadShuffle) {
                const btn = document.getElementById('shuffle-btn');
                isBtnLocked = true;
                btn.classList.add('locked');
                btn.innerText = 'nuh-uh!';
                setTimeout(() => { btn.classList.remove('locked'); btn.innerText = 'Shuffle'; isBtnLocked = false; }, 1000);
                return;
            }
        }
        shuffleBoard(false);
    }

    function shuffleExistingCards() {
        if (isAnimating || isGameOver) return;
        isAnimating = true;
        for (let i = board.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [board[i], board[j]] = [board[j], board[i]];
        }
        selected = [];
        const slots = document.getElementById('board').children;
        for (let i = 0; i < slots.length; i++) {
            updateSlot(i, false);
            const cardEl = slots[i].querySelector('.card');
            if (cardEl) {
                cardEl.classList.add('jumping');
                cardEl.addEventListener('animationend', () => { cardEl.classList.remove('jumping'); }, { once: true });
            }
        }
        updateUI();
        setTimeout(() => { isAnimating = false; }, 200);
    }

    function shuffleBoard(isAuto = false) {
        if (isAnimating) return;
        isAnimating = true;
        document.querySelectorAll('.card').forEach(c => c.classList.add('anim-out'));
        setTimeout(() => {
            const currentCards = board.filter(c => c !== null);
            deck.push(...currentCards);
            deck.sort(() => Math.random() - 0.5);
            board = deck.splice(0, 12);
            selected = [];
            for (let i=0; i<12; i++) updateSlot(i, true);
            isAnimating = false;
            updateUI();
        }, 80);
    }

    function saveRecord() {
        if (collectedSets < config.minSetsToRecord) return;
        const elapsedMs = (Date.now() - startTime);
        const now = new Date();
        const dateStr = `${String(now.getDate()).padStart(2,'0')}.${String(now.getMonth()+1).padStart(2,'0')}.${String(now.getFullYear()).slice(-2)} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        const records = JSON.parse(localStorage.getItem('set_pro_records') || '[]');
        records.push({ id: Date.now(), sets: collectedSets, time: elapsedMs, badShuffles: badShuffles, date: dateStr, isSeed: config.useFixedSeed });
        localStorage.setItem('set_pro_records', JSON.stringify(records));
    }

    function calculateSpeedData(totalTimeMs) {
        const intervalMs = 10000; 
        const points = Math.ceil(totalTimeMs / intervalMs);
        const labels = [];
        const data = [];
        for (let i = 1; i <= points; i++) {
            const currentTime = i * intervalMs;
            labels.push(formatTime(currentTime));
            const setsInInterval = setTimestamps.filter(ts => {
                const relativeTs = ts - startTime;
                return relativeTs > (currentTime - intervalMs) && relativeTs <= currentTime;
            }).length;
            const spm = (setsInInterval / (intervalMs / 1000)) * 60;
            data.push(spm.toFixed(1));
        }
        return { labels, data };
    }

    function renderSpeedChart(totalTimeMs) {
        const ctx = document.getElementById('speedChart').getContext('2d');
        const { labels, data } = calculateSpeedData(totalTimeMs);
        if (speedChartInstance) speedChartInstance.destroy();
        speedChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Sets/min',
                    data: data,
                    borderColor: '#ec4899',
                    backgroundColor: 'rgba(236, 72, 153, 0.1)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: true, grid: { display: false }, ticks: { color: '#888', font: { size: 9 }, maxRotation: 0 } },
                    y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#888', font: { size: 9 } } }
                }
            }
        });
    }

    async function shareResult() {
        const source = document.getElementById('share-content');
        const clone = source.cloneNode(true);
        const exportHeader = clone.querySelector('#export-header');
        const resultTitle = clone.querySelector('#result-title');
        const finalDate = clone.querySelector('#final-date-display');
        const statCards = clone.querySelectorAll('.stat-card');
        const statLabels = clone.querySelectorAll('.stat-label');
        const statValues = clone.querySelectorAll('.stat-value');
        const exportW = 430, exportH = 430;
        clone.style.width = `${exportW}px`;
        clone.style.height = `${exportH}px`;
        clone.style.padding = '15px';
        clone.style.display = 'flex';
        clone.style.flexDirection = 'column';
        clone.style.alignItems = 'center';
        clone.style.justifyContent = 'flex-start'; 
        clone.style.backgroundColor = '#2d2631';
        clone.style.position = 'fixed';
        clone.style.left = '-9999px';
        clone.style.top = '0';
        clone.style.zIndex = '9999';
        exportHeader.style.display = 'block';
        exportHeader.style.marginBottom = '5px';
        resultTitle.style.margin = '0';
        resultTitle.style.padding = '0';
        resultTitle.style.lineHeight = '0.8'; 
        resultTitle.style.marginBottom = '20px';
        statCards.forEach(card => {
            card.style.display = 'flex'; 
            card.style.flexDirection = 'column';
            card.style.padding = '10px 14px';
            card.style.height = '64px';
            card.style.justifyContent = 'flex-start';
            card.style.position = 'relative';
        });
        statLabels.forEach(label => { label.style.display = 'block'; label.style.marginBottom = '5px'; label.style.lineHeight = '1'; });
        statValues.forEach(val => {
            val.style.position = 'relative';
            let topOffset = -12;
            if (val.id === 'final-ext-find') topOffset = -3; 
            val.style.top = `${topOffset}px`; 
            val.style.display = 'block';
            val.style.lineHeight = '1.1';
        });
        finalDate.style.display = 'block';
        finalDate.style.marginTop = '12px';
        const originalCanvas = source.querySelector('canvas');
        const clonedCanvas = clone.querySelector('canvas');
        const ctx = clonedCanvas.getContext('2d');
        clonedCanvas.width = originalCanvas.width;
        clonedCanvas.height = originalCanvas.height;
        ctx.drawImage(originalCanvas, 0, 0);
        document.body.appendChild(clone);
        try {
            await new Promise(r => setTimeout(r, 150));
            const canvas = await html2canvas(clone, { backgroundColor: '#2d2631', scale: 2, width: exportW, height: exportH, logging: false, useCORS: true });
            canvas.toBlob(async (blob) => {
                const file = new File([blob], 'set_pro_result.png', { type: 'image/png' });
                if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({ files: [file], title: 'Set Pro Result', text: `Sets: ${collectedSets} | Time: ${document.getElementById('final-time').innerText}` });
                } else {
                    const link = document.createElement('a');
                    link.download = `set_result_${Date.now()}.png`;
                    link.href = URL.createObjectURL(blob);
                    link.click();
                }
            }, 'image/png');
        } catch (err) { console.error("Error sharing:", err); } finally { document.body.removeChild(clone); }
    }

    function finishGame() {
        if (isGameOver) return;
        isGameOver = true;
        const elapsedMs = (Date.now() - startTime);
        saveRecord();
        const now = new Date();
        const dateStr = now.toLocaleDateString('ru-RU') + ' ' + now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
        document.getElementById('final-date-display').innerText = dateStr;
        let findIntervals = [];
        let prev = startTime;
        setTimestamps.forEach(ts => { findIntervals.push(ts - prev); prev = ts; });
        const maxFind = findIntervals.length ? Math.max(...findIntervals) : 0;
        const minFind = findIntervals.length ? Math.min(...findIntervals) : 0;
        const avgFind = findIntervals.length ? (findIntervals.reduce((a, b) => a + b, 0) / findIntervals.length) : 0;
        document.getElementById('final-time').innerText = formatTime(elapsedMs, true);
        document.getElementById('final-score').innerText = collectedSets;
        document.getElementById('final-bad-shuffles').innerText = badShuffles;
        document.getElementById('final-avg-find').innerText = avgFind ? formatTime(avgFind, true) : '--:--';
        document.getElementById('final-ext-find').innerHTML = `F: ${minFind ? formatTime(minFind, true) : '--'}<br>S: ${maxFind ? formatTime(maxFind, true) : '--'}`;
        renderSpeedChart(elapsedMs);
        const modal = document.getElementById('result-modal');
        modal.classList.remove('hide');
        modal.classList.add('show');
        setTimeout(() => {
            document.querySelectorAll('.card').forEach(c => c.classList.add('anim-out'));
            setTimeout(() => { initNewDeckAndBoard(); }, 100);
        }, 150);
    }

    function initNewDeckAndBoard() {
        deck = createDeck();
        board = deck.splice(0, 12);
        selected = [];
        for (let i=0; i<12; i++) updateSlot(i, false);
    }

    function resetStats() {
        collectedSets = 0; badShuffles = 0;
        startTime = Date.now();
        setTimestamps = [];
        possibleHistory = [];
        document.getElementById('timer').innerText = "00:00";
    }

    async function resetGame() {
        const modal = document.getElementById('result-modal');
        if (modal.classList.contains('show')) {
            modal.classList.add('hide');
            await new Promise(r => setTimeout(r, 200));
            modal.classList.remove('show', 'hide');
        }
        isGameOver = false;
        resetStats();
        updateUI();
    }

    function openRecords() {
        const records = JSON.parse(localStorage.getItem('set_pro_records') || '[]');
        records.sort((a, b) => b.sets - a.sets || a.time - b.time);
        const container = document.getElementById('records-container');
        container.innerHTML = records.length ? '' : '<p class="text-center text-gray-500 mt-10">No records yet</p>';
        records.forEach(r => {
            const item = document.createElement('div');
            item.className = 'record-item';
            item.innerHTML = `
                <div class="record-info"><div class="record-val">${r.sets} Sets ${r.isSeed ? '🧬' : ''}</div><div class="text-[10px] uppercase opacity-70">${r.date}</div></div>
                <div class="record-info text-right"><div class="text-white font-mono">${formatTime(r.time, true)}</div><div class="text-[10px] uppercase text-red-400">BS: ${r.badShuffles}</div></div>
                <div class="btn-del" onclick="deleteRecord(event, ${r.id})"><svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></div>
            `;
            container.appendChild(item);
        });
        document.getElementById('records-modal').classList.remove('hide');
        document.getElementById('records-modal').classList.add('show');
    }

    function deleteRecord(event, id) {
        event.stopPropagation();
        if (confirm('Delete this record?')) {
            let records = JSON.parse(localStorage.getItem('set_pro_records') || '[]');
            records = records.filter(r => r.id !== id);
            localStorage.setItem('set_pro_records', JSON.stringify(records));
            openRecords();
        }
    }

    async function closeRecords() {
        const modal = document.getElementById('records-modal');
        modal.classList.add('hide');
        await new Promise(r => setTimeout(r, 200));
        modal.classList.remove('show', 'hide');
    }

    function openKeybinds() {
        const grid = document.getElementById('kb-board-grid');
        grid.innerHTML = '';
        binds.board.forEach((key, i) => {
            const cell = document.createElement('div');
            cell.className = 'kb-cell';
            cell.id = `kb-slot-${i}`;
            cell.innerText = key === ' ' ? 'SPC' : key.toUpperCase();
            cell.onclick = () => startCapture('board', i);
            grid.appendChild(cell);
        });
        syncKeybindsUI();
        document.getElementById('keybinds-modal').classList.remove('hide');
        document.getElementById('keybinds-modal').classList.add('show');
    }

    function startCapture(type, index = null) {
        if (isCapturingKey) return;
        isCapturingKey = { type, index };
        const elId = index !== null ? `kb-slot-${index}` : `kb-${type.replace('Ex', '-ex')}`;
        document.querySelectorAll('.kb-cell').forEach(c => c.classList.remove('waiting'));
        document.getElementById(elId).classList.add('waiting');
    }

    function syncKeybindsUI() {
        document.getElementById('kb-shuffle').innerText = (binds.shuffle === ' ' ? 'SPC' : binds.shuffle.toUpperCase()) || '---';
        document.getElementById('kb-shuffle-ex').innerText = (binds.shuffleEx === ' ' ? 'SPC' : binds.shuffleEx.toUpperCase()) || '---';
        document.getElementById('kb-finish').innerText = (binds.finish === ' ' ? 'SPC' : binds.finish.toUpperCase()) || '---';
        binds.board.forEach((key, i) => {
            const cell = document.getElementById(`kb-slot-${i}`);
            if(cell) cell.innerText = (key === ' ' ? 'SPC' : key.toUpperCase()) || '---';
        });
    }

    async function closeKeybinds() {
        const modal = document.getElementById('keybinds-modal');
        modal.classList.add('hide');
        await new Promise(r => setTimeout(r, 200));
        modal.classList.remove('show', 'hide');
        localStorage.setItem('set_keybinds', JSON.stringify(binds));
    }

    function resetKeybinds() {
        if (confirm('Reset keys to default?')) {
            binds = JSON.parse(JSON.stringify(DEFAULT_BINDS));
            openKeybinds();
        }
    }

    let touchStartY = 0;
    const swipeZone = document.getElementById('swipe-zone');
    
    window.addEventListener('touchstart', (e) => { 
        const touch = e.touches[0];
        const rect = swipeZone.getBoundingClientRect();
        if (touch.clientX >= rect.left && touch.clientX <= rect.right &&
            touch.clientY >= rect.top && touch.clientY <= rect.bottom) {
            touchStartY = touch.clientY; 
        } else {
            touchStartY = null;
        }
    }, { passive: false });

    window.addEventListener('touchmove', (e) => {
        if (touchStartY !== null && Math.abs(e.touches[0].clientY - touchStartY) > 10) {
            e.preventDefault();
        }
    }, { passive: false });

    window.addEventListener('touchend', (e) => {
        if (touchStartY === null) return;
        const touchEndY = e.changedTouches[0].clientY;
        const diff = touchStartY - touchEndY;
        // Свайп вверх (diff > 50)
        if (diff > 50) {
            shuffleExistingCards();
        }
        touchStartY = null;
    }, { passive: false });

    window.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT') return;
        let key = e.key.toLowerCase();
        if (KEY_MAP[key]) key = KEY_MAP[key];
        if (isCapturingKey) {
            e.preventDefault();
            const { type, index } = isCapturingKey;
            if (binds.shuffle === key) binds.shuffle = '';
            if (binds.shuffleEx === key) binds.shuffleEx = '';
            if (binds.finish === key) binds.finish = '';
            binds.board = binds.board.map(b => b === key ? '' : b);
            if (type === 'board') binds.board[index] = key;
            else binds[type] = key;
            isCapturingKey = null;
            syncKeybindsUI();
            document.querySelectorAll('.kb-cell').forEach(c => c.classList.remove('waiting'));
            return;
        }
        if (isGameOver) { if (key === binds.finish && key !== '') resetGame(); return; }
        if (key !== '' && key === binds.shuffle) { e.preventDefault(); handleShuffleClick(); } 
        else if (key !== '' && key === binds.shuffleEx) { e.preventDefault(); shuffleExistingCards(); } 
        else if (key !== '' && key === binds.finish) { e.preventDefault(); finishGame(); } 
        else if (key !== '') {
            const boardIdx = binds.board.indexOf(key);
            if (boardIdx !== -1) {
                const slot = document.getElementById('board').children[boardIdx];
                const cardEl = slot?.querySelector('.card');
                if (cardEl) toggleSelect(boardIdx, cardEl);
            }
        }
    });

    setInterval(() => {
        if (!isGameOver && !document.querySelector('.overlay.show')) {
            const elapsedMs = (Date.now() - startTime);
            document.getElementById('timer').innerText = formatTime(elapsedMs, false);
        }
    }, 1000);

    initNewDeckAndBoard();
    updateColors();
    syncSettingsUI();
    updateUI();
</script>
</body>
</html>
